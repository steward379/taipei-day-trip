<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>phrase 2 - Week 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" user-scalable=1>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
  <!-- <link rel="stylesheet" href="./style.css"> -->
  <script src="https://kit.fontawesome.com/53c20d969e.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

</head>

<body>
  <header>
    <nav>
      <h1><b> <a href="/">台北一日遊</a></b></h1>
      <input type="checkbox" id="hamburger-menu-click" />
      <label for="hamburger-menu-click" class="hamburger-menu-label">
        <svg class="hamburger-menu" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512">
          <path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z" />
        </svg>
        <svg class="xmark" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512">
          <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z" />
        </svg>

        <!--           <div class="nav-list-accordion"></div> -->

      </label>
      <ul class="nav-list">
        <li class="nav-item">預定行程</li>
        <li class="nav-item">登入/註冊</li>
      </ul>
    </nav>
  </header>
  <div class="container">
    <div class="jumbotron" style="background-image: url({{ url_for('static', filename='images/jumbotron-bg.png') }});">
      <div class="jumbotron-text">
        <h2>輕鬆享受台北一日悠閒</h2>
        <p>探索每個角落，體驗城市的深度旅遊行程</p>
        <div class="search-bar">
          <input type="text" placeholder="輸入景點名稱查詢" id="search-input">
          <button title="search-query" type="submit" id="search-button">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="button-wrapper">
      <!-- <button class="keyword-button" data-keyword="關鍵字1">關鍵字1</button> -->
    </div>
    <main>
      <!-- <ul class="photo-profile">
        <li class="profile-li profile-li-1">
          <div class="profile-img profile-img-1">
            <img alt="profile-img-1" class="main-image" src="http://placekitten.com/420/500" />
            <svg xmlns="http://www.w3.org/2000/svg" fill="white" class="star" height="1.5em" viewBox="0 0 576 512">
              <path d="M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z" />
            </svg>
            <div class="profile-title profile-title-1">
              <span>Title 1</span>
            </div>
          </div>
          <ul class="profile-des">
            <li>忠孝復興</li>
            <li>公共藝術</li>
          </ul> 
        </li>
      </ul> -->
    </main>
  </div>
  <footer>
    <span>COPYRIGHT © 2021 台北一日遊</span>
  </footer>

  <script>
    let nextPage = null;
    let currentPage = 0;
    let isLoading = false;
    let keyword = "";

    document.getElementById("search-button").addEventListener("click", function() {
      keyword = document.getElementById("search-input").value;
      currentPage = 0;
      fetchData();
    });

    async function fetchMrtData() {
      const url = "http://127.0.0.1:3000/api/mrts";
      const response = await fetch(url);
      const dataJson = await response.json();
      generateButtons(dataJson.data);
    }

    async function generateButtons(mrtData) {
      const buttonWrapper = document.querySelector('.button-wrapper');
      buttonWrapper.innerHTML = "";

      mrtData.forEach((mrt, index) => {
        const button = document.createElement("button");
        button.className = "keyword-button";
        button.textContent = mrt;
        button.addEventListener('click', function() {
          const searchInput = document.getElementById('search-input');
          searchInput.value = this.textContent;
          keyword = this.textContent;

          currentPage = 0;
          fetchData(true);
        });
        buttonWrapper.appendChild(button);
      });
    };

    window.addEventListener('load', async () => {
      await fetchMrtData();
      fetchData();
    });

    // document.querySelectorAll('.keyword-button').forEach(button => {
    //   button.addEventListener('click', function() {
    //     const keyword = this.getAttribute('data-keyword'); // 從 data-keyword 屬性獲取關鍵字
    //     const searchInput = document.getElementById('search-input');
    //     searchInput.value = keyword; // 將搜尋框的值設為按鈕的關鍵字
    //   });
    // });

    let observer = new IntersectionObserver(entries => {
      if (entries[0].isIntersecting && !isLoading) {
        if (nextPage !== null) {
          currentPage = nextPage;
          fetchData();
        }
      }
    }, {});

    async function fetchData(mrtOnly = false) {
      isLoading = true;

      try {
        console.log(`Fetching data for page ${currentPage} (human ${currentPage +1}  ) on ${keyword ? keyword : "all attractions"}.`);
        // const url = `http://54.253.20.174:3000/api/attractions?page=${currentPage}`;
        let url = `http://127.0.0.1:3000/api/attractions?page=${currentPage}`;
        if (keyword) {
          url += `&keyword=${keyword}`;
        }
        if (mrtOnly) {
          url += `&mrtOnly=true`;
        }
        console.log(url);

        const response = await fetch(url);
        const data = await response.json();

        // fetch(url)
        //   .then(response => response.json())
        //   .then(data => {
        if (currentPage === 0 && document.querySelector('.photo-profile')) {
          document.querySelector('.photo-profile').innerHTML = '';
        }

        createElements(data);

        isLoading = false;

        // async await
        setTimeout(() => {
          const ulProfile = document.querySelector('.photo-profile');
          observer.observe(ulProfile.lastChild);
        }, 300); // 延遲 300 毫秒

        nextPage = data["nextPage"];
        console.log("nextPage", nextPage);
        // })
      } catch (err) {
        console.log('Error Fetching data:', err);
        isLoading = false;
      }
    }

    function createElements(data) {
      const attractions = data["data"];
      const nextPage = data["nextPage"];
      const attractionsCount = attractions.length;

      if (attractionsCount === 0) {
        document.querySelector('main').innerText = '沒有結果';
        return;
      }

      const mainElement = document.querySelector('main');
      let ulProfile = mainElement.querySelector('.photo-profile') || document.createElement('ul');

      ulProfile.className = `photo-profile`;

      for (let i = 0; i < attractionsCount; i++) {
        let liProfile = document.createElement(`li`);
        liProfile.className = `profile-li profile-li-${i}`;
        profileGenerate(i, attractions, liProfile);
        ulProfile.appendChild(liProfile);
      }

      if (!mainElement.contains(ulProfile)) {
        mainElement.appendChild(ulProfile);
        // 無限捲動
        observer.observe(ulProfile.lastChild);
      }
    }

    function profileGenerate(i, attractions, newProfileList) {

      let divElement = document.createElement("div");
      divElement.className = `profile-img profile-img-${i}`;

      let imgElement = document.createElement("img");
      // imgElement.src = "https://" + attractions[i].file.split('https://')[1]; // 使用 JSON 資料中的圖片 URL
      // imgElement.src = attractions[i].images[0] || "http://placekitten.com/420/500";

      if (attractions[i].images && attractions[i].images[0]) {
        imgElement.src = attractions[i].images[0];
        divElement.appendChild(imgElement); // 將img元素添加到div容器中
      } else {
        let textDiv = document.createElement("div");
        textDiv.className = "fallback-text";
        textDiv.textContent = "【缺圖中】" + attractions[i].name;

        divElement.appendChild(textDiv); // 將含有名稱的div添加到div容器中
      }
      imgElement.alt = `profile-img-${i}`;
      imgElement.className = "main-image";

      // let svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      // svgElement.setAttribute("class", "star");
      // svgElement.setAttribute("xmlns", "http://www.w3.org/2000/svg");
      // svgElement.setAttribute("fill", "white");
      // svgElement.setAttribute("height", "1.5em");
      // svgElement.setAttribute("viewBox", "0 0 576 512");

      // let pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      // pathElement.setAttribute('d',
      //   'M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z'
      // );

      let divElementTitle = document.createElement("div");
      divElementTitle.className = `profile-title profile-title-${i}`;

      let spanElement = document.createElement("span");
      spanElement.textContent = attractions[i].name;

      let ulElement = document.createElement("ul");
      ulElement.className = `profile-des profile-des-${i}`;

      let liElement = document.createElement("li");
      liElement.textContent = attractions[i].mrt;
      liElement.className = `profile-des-li-mrt`;

      let liElement2 = document.createElement("li");
      liElement2.textContent = attractions[i].category;
      liElement2.className = `profile-des-li-category`;

      newProfileList.appendChild(divElement);
      divElement.appendChild(imgElement);
      // divElement.appendChild(svgElement);
      // svgElement.appendChild(pathElement);
      divElement.appendChild(divElementTitle);
      divElementTitle.appendChild(spanElement);
      newProfileList.appendChild(ulElement);
      ulElement.appendChild(liElement);
      ulElement.appendChild(liElement2);
    }
  </script>
</body>

</html>